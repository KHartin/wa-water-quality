---
title: "Washington State Drinking Water Fluoridation"
author: "Brian High"
date: "05/17/2015"
output:
  pdf_document:
    fig_caption: yes
  html_document:
    fig_caption: yes
    fig_width: 8
    keep_md: yes
---

## Introduction

This project explores the use of publicly available data to investigate 
drinking water system fluoride levels in Washington State. Methods for 
reproducible data cleanup and exploratory analysis using R, RMarkdown, knitr, 
are demonstrated, as well as some of the plotting capabilities of ggplot2.

## Data Sources

Data files have been prepared using a companion 
[Markdown script](https://github.com/brianhigh/wa-water-quality/blob/master/data_cleanup_and_export.md) 
to generate text data files. These data and Markdown files are hosted in the 
[wa-water-quality](https://github.com/brianhigh/wa-water-quality) repository 
on [GitHub](https://github.com).

The water system data come from [WA DOH Water System Data](http://www.doh.wa.gov/DataandStatisticalReports/EnvironmentalHealth/DrinkingWaterSystemData/DataDownload) and [WA DOH Fluoride in Driking Water](http://www.doh.wa.gov/DataandStatisticalReports/EnvironmentalHealth/DrinkingWaterSystemData/FluorideinDrinkingWater). The lat/long coordinates were generated using the [ggmap](http://journal.r-project.org/archive/2013-1/kahle-wickham.pdf) package for R.

## Setup

Load the required R packages.

```{r, echo=TRUE, message=FALSE}
for (pkg in c("knitr", "dplyr", "ggplot2", "maps")) {
    if (! suppressWarnings(require(pkg, character.only=TRUE)) ) {
        install.packages(pkg, repos="http://cran.fhcrc.org", dependencies=TRUE)
        if (! suppressWarnings(require(pkg, character.only=TRUE)) ) {
            stop(paste0(c("Can't load package: ", pkg, "!"), collapse = ""))
        }
    }
}
```

Configure `knitr` options.

```{r set_options, echo=TRUE, message=FALSE}
opts_chunk$set(tidy=FALSE, cache=TRUE)
```

Create the data folder if needed.

```{r}
datadir <- "data"
dir.create(file.path(datadir), showWarnings=FALSE, recursive=TRUE)
```

Read in the location coordinates from a text file if you have saved one 
previously.

```{r}
tsv_import <- function(filename) {
    infile <- paste(c(datadir, '/', filename), sep='', collapse='')
    if (file.exists(infile)) {
        read.delim(infile, stringsAsFactors=FALSE, header=TRUE)
    }
    else {
        stop(paste("Can't find", filename, "in folder", datadir, "!", sep=" "))
    }
}

locations <- tsv_import('wa_doh_dw_locations.tsv')
systems <- tsv_import('wa_doh_dw_systems.tsv')
fluoride <- tsv_import('wa_doh_dw_fluoride.tsv')
```

## Join Tables

Join the location and water system data into a new table for use in plotting.

```{r}
systems <- inner_join(locations, systems, by=c("PWSCity", "WSState", "WSZipCode"))
fl <- select(systems, PWSID, PWSCity, WSState, WSZipCode, 
                          OwnerTypeDesc, lon, lat)
fl$OwnerTypeDesc <- as.factor(fl$OwnerTypeDesc)

fl <- inner_join(fl, fluoride, by=c("PWSID"))
fl$Treatment <- as.factor(fl$Treatment)

# Add some grouping factors
fl$FLevel <- cut(fl$mgL, c(0,.8,1.3, Inf), labels=c("Low", "Optimal", "High"))
fl$Population <- cut(fl$ResPop, 
    c(0, 100, 1000, 10000, Inf), labels=c("0-100", "100-1K", "1K-10K", ">10K"))

nat.fl <- filter(fl, Treatment == "NATURAL")
nat.fl <- select(nat.fl, County, PWSID, SystemName, mgL, ResPop, OwnerTypeDesc, 
                 lon, lat, Treatment, FLevel, Population)

nat.fl <- nat.fl[complete.cases(nat.fl),]

nat.fl.high <- nat.fl[nat.fl$mgL>1.3,]
nat.fl.high <- nat.fl.high[complete.cases(nat.fl.high),]
```

## Violin Plot of Natural Fluoride Levels

Make a violin plot of fluoride levels by system owner type. The points represent 
Washington State water systems with natural (non-fluoridated) fluoride concentration 
levels. The colors indicate the size of the population served by the water system. 
The width of the shapes vary according to the density of points plotted at a 
given fluoride level. The light green band shows Washington's range of "optimal" 
fluoride levels (0.8 to 1.3 mg/L). The green line marks the new (April, 2015) 
[US HHS](http://www.hhs.gov/news/press/2015pres/04/20150427a.html) 
[recommended](http://www.cdc.gov/fluoridation/faqs/) level of 0.7 mg/L.

```{r WA-Water-Systems-By-owner-Type, cache=FALSE, fig.cap="Washington State Water Systems by Owner Type"}
ggplot(nat.fl, aes(x=OwnerTypeDesc, y=log(mgL))) + 
    geom_violin(alpha=0.5, color="gray") + geom_jitter(size=2, alpha=0.3,
      position = position_jitter(width = 0.05), aes(color=Population)) +
    theme(axis.text.x = element_text(angle=45, vjust=1, size=11, hjust=1)) +
    scale_color_manual(values=c("blue", "green", "orange", "red")) + 
    coord_equal() + 
    labs(title=paste("Natural Fluoride Levels", "in Washington Water Sources", 
                     "by Water System Owner Type", sep="\n"), 
        x="Water System Owner Type", y = "log(FLevel)") +
    geom_rect(data=nat.fl[1,], 
              aes(ymin=log(.8), ymax=log(1.3), xmin=0, xmax=Inf), 
              fill="green", alpha=.1, label="Optimal Fluoridation") + 
    geom_text(aes(7.5, 0, label="WA.Optimal", group=NULL), size = 4, 
        color = "darkgreen", data=nat.fl[1,], parse = T) + 
    geom_hline(aes(yintercept=log(0.7), alpha=.5), color = "darkgreen") + 
    geom_text(aes(7.5, -.5, label="US.2015", group=NULL), size = 4, 
        color = "darkgreen", data=nat.fl[1,], parse = T) +
    guides(col = guide_legend(reverse = FALSE))
```

## Prepare Map Data

Prepare the map `data.frame` using the `map_data` function from the `ggplot2`
package.

```{r}
# Capitalize first letter of word - for use with proper nouns
# From documentation for `tolower` in package _base_ 3.1.3
capwords <- function(s, strict = FALSE) {
    cap <- function(s) paste(toupper(substring(s, 1, 1)),
                  {s <- substring(s, 2); if(strict) tolower(s) else s},
                             sep = "", collapse = " " )
    sapply(strsplit(s, split = " "), cap, USE.NAMES = !is.null(names(s)))
}

# Mappings of counties by state
county_df <- map_data('county')

# Subset just for WA
wa <- subset(county_df, region=="washington")
wa$subregion <- sapply(wa$subregion, function(x) capwords(x))
wa$county <- wa$subregion
cnames <- aggregate(cbind(long, lat) ~ subregion, data=wa, 
                    FUN=function(x)mean(range(x)))

# Create the base state map with counties outlined in grey
wamap <- ggplot(wa, aes(long, lat)) +  
    geom_polygon(aes(group=group), color='darkgrey', fill=NA) +
    geom_text(data=cnames, aes(long, lat, label = subregion), size=3) + 
    theme_classic()  + 
    theme(axis.line=element_blank(),
      axis.text.x=element_blank(),
      axis.text.y=element_blank(),
      axis.ticks=element_blank(),
      axis.title.x=element_blank(),
      axis.title.y=element_blank())
```

## Untreated: Natural Fluoride Levels

Make a map of populations served by non-fluoridated water systems with natural 
fluoride levels.

```{r WA-Natural-Fluoride, cache=FALSE, fig.cap="Washington State Natural Fluoride Water Systems"}
wamap + geom_point(data=nat.fl, inherit.aes=F, 
            aes(x=lon, y=lat, group=FLevel, color=FLevel, size=Population, 
                fill=FLevel), 
        position=position_jitterdodge(jitter.width=0.1, dodge.width=0.1), 
        alpha=.3) + scale_shape_discrete(solid=T) + 
    scale_size_manual(values = seq(2, 9, by=2)) +
    scale_color_manual(values=c("blue", "green", "red")) + 
    ggtitle(label = paste("Washington Populations Served by Water Systems",
                          "with Natural (Untreated) Fluoride Levels", 
                          "Relative to Washington State's",
                          "\"Optimal\" Range (0.8 - 1.3 mg/L)", sep="\n"))
```

## Natural: Exceeding Optimal Fluoride Levels

Make a map of populations served by water systems with natural fluoride levels 
above Washington State's "optimal" range of 0.8 - 1.3 mg/L.

```{r WA-Natural-Fluoride-Over, cache=FALSE, fig.cap="Washington State Natural Fluoride Levels Over Range"}
wamap + geom_point(data=nat.fl.high, inherit.aes=F, 
               aes(x=lon, y=lat, size=Population), colour="red", alpha=.3) +
        scale_size_manual(values = seq(2, 9, by=2)) +
    ggtitle(label = paste("Washington Populations Served by Water Systems",
                          "with Natural (Untreated) Fluoride Levels", 
                          "Above Washington State's",
                          "\"Optimal\" Range (0.8 - 1.3 mg/L)", sep="\n"))
```

## All Systems: Optimal and Nonoptimal Fluoride Levels

Make a map of populations served by water systems with natural or treated 
fluoride levels falling inside or outside of Washington State's "optimal" range 
of 0.8 - 1.3 mg/L.

```{r WA-Optimal-Fluoride, cache=FALSE, fig.cap="Washington State Optimal and Nonoptimal Fluoride Levels"}
fl$Optimal <- with(fl, Treatment=="TREATED" | Treatment=="INTERTIED" | FLevel == "Optimal")
fl$Optimal <- factor(c('No', 'Yes')[fl$Optimal + 1])
fl.opt <- select(fl, County, PWSID, SystemName, ResPop, OwnerTypeDesc, 
                 lon, lat, Treatment, Population, Optimal)
fl.opt <- fl[complete.cases(fl.opt),]

wamap + geom_point(data=fl.opt, inherit.aes=F, 
               aes(x=lon, y=lat, size=Population, color=Optimal), alpha=.3) +
    scale_size_manual(values = seq(2, 9, by=2)) +
    scale_color_manual(values=c("red", "green")) +
    ggtitle(label = paste("Washington Populations Served by Water Systems",
                          "with Fluoride Levels Relative to Washington State's",
                          "\"Optimal\" Range (0.8 - 1.3 mg/L)", sep="\n"))
```

